<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>
    {% if request.query_params.get('user_id') %}
        –ó–∞–∫–∞–∑—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Ññ{{ request.query_params.get('user_id') }}
    {% else %}
        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏
    {% endif %}
</title>
    <style>
        :root {
            --primary: #4361ee;
            --success: #4cc9f0;
            --warning: #f72585;
            --danger: #e63946;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --border: #dee2e6;
            --shadow: rgba(0, 0, 0, 0.1);
            --radius: 10px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* –ù–û–í–´–ï –°–¢–ò–õ–ò –î–õ–Ø –§–ò–õ–¨–¢–†–ê */
        .filters {
            background: white;
            border-radius: var(--radius);
            box-shadow: 0 4px 12px var(--shadow);
            padding: 20px;
            margin-bottom: 30px;
        }

        .filter-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            font-weight: 500;
            margin-bottom: 5px;
            color: var(--dark);
        }

        .filter-group input,
        .filter-group select {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-family: inherit;
        }

        .filter-button {
            height: 40px;
            line-height: 40px;
            text-align: center;
            padding: 0 20px;
            border: none;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            width: 120px;
            box-sizing: border-box;
        }

        .filter-button:hover {
            background-color: #3a56e4; /* slightly darker */
        }

        .filter-button:active {
            transform: translateY(1px);
        }

        @media (max-width: 768px) {
            .filter-row {
                flex-direction: column;
            }

            .filter-group {
                width: 100%;
            }

            .filter-button {
                align-self: stretch;
            }
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: var(--dark);
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: var(--radius);
            box-shadow: 0 4px 12px var(--shadow);
        }

        h1 {
            font-size: 2.2rem;
            color: var(--primary);
            margin-bottom: 10px;
        }

        .summary {
            font-size: 1.2rem;
            color: var(--gray);
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π —Å—Ç–∏–ª—å –∑–∞–∫–∞–∑–∞ */
        .order {
            background: white;
            border-radius: var(--radius);
            box-shadow: 0 4px 10px var(--shadow);
            margin-bottom: 25px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer; /* –ö—É—Ä—Å–æ—Ä —É–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –º–æ–∂–Ω–æ –∫–ª–∏–∫–Ω—É—Ç—å */
        }

        .order:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px var(--shadow);
        }

        /* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–∫–∞–∑–∞ - –≤—Å–µ–≥–¥–∞ –≤–∏–¥–µ–Ω */
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: linear-gradient(to right, #f1f3f9, #e9ecef);
            border-bottom: 1px solid var(--border);
        }

        .order-number {
            font-weight: bold;
            font-size: 1.4rem;
            color: var(--primary);
        }

        .order-status {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            text-align: center;
            display: inline-block;
        }

        .status-new { background: #fff3cd; color: #856404; }
        .status-confirmed { background: #d1ecf1; color: #0c5460; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        .status-delivered { background: #d4edda; color: #155724; }

        /* –°—Ç—Ä–µ–ª–∫–∞ –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ü–∏–∏ —Ä–∞—Å–∫—Ä—ã—Ç–∏—è */
        .toggle-icon {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .order.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        /* –°–∫—Ä—ã—Ç–∞—è —á–∞—Å—Ç—å –∑–∞–∫–∞–∑–∞ */
        .order-details {
            display: none; /* –°–∫—Ä—ã—Ç–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
            padding: 20px;
            background: white;
        }

        .order.expanded .order-details {
            display: block; /* –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Ä–∞—Å–∫—Ä—ã—Ç–∏–∏ */
        }

        .customer-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }

        .items-table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }

        .items-table th,
        .items-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .items-table th {
            background: #e9ecef;
            font-weight: 600;
            color: var(--dark);
        }

        .items-table tr:nth-child(even) {
            background: #f8f9fa;
        }

        .order-footer {
            padding: 20px;
            background: #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid var(--border);
        }

        .order-total {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--primary);
        }

        .status-actions button {
            padding: 8px 16px;
            margin-left: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }

        .btn-confirm { background: #28a745; color: white; }
        .btn-cancel { background: #dc3545; color: white; }
        .btn-delivered { background: #ffc107; color: black; }

        .status-actions button:hover { opacity: 0.9; }

        @media (max-width: 768px) {
            .order-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .order-status {
                margin-top: 10px;
            }

            .order-footer {
                flex-direction: column;
                align-items: flex-start;
            }

            .status-actions {
                margin-top: 15px;
            }

            .status-actions button {
                margin-top: 5px;
                margin-left: 0;
            }
        }


    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>
    <a href="/orders/orders-page/" style="text-decoration: none; color: inherit;">
        {% if request.query_params.get('user_id') %}
        –ó–∞–∫–∞–∑—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ‚Ññ{{ request.query_params.get('user_id') }}<br>
        ‚Ü©Ô∏è –Ω–∞–∑–∞–¥
    {% else %}
        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞–º–∏
    {% endif %}
    </a>
</h1>
            <p class="summary">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤: {{ orders|length }}</p>
        </header>
        <div class="filters">
    <form id="filter-form" method="GET">
        <div class="filter-row">
            {% if request.query_params.get('user_id') %}
            <input type="hidden" name="user_id" value="{{ request.query_params.get('user_id') }}">
            {% endif %}

            <div class="filter-group">
                <label for="date_from">–î–∞—Ç–∞ –æ—Ç:</label>
                <input type="date" id="date_from" name="date_from" value="{{ request.query_params.get('date_from', '') }}">
            </div>

            <div class="filter-group">
                <label for="date_to">–î–∞—Ç–∞ –¥–æ:</label>
                <input type="date" id="date_to" name="date_to" value="{{ request.query_params.get('date_to', '') }}">
            </div>

            <div class="filter-group">
                <label for="status">–°—Ç–∞—Ç—É—Å:</label>
                <select id="status" name="status">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="new" {% if request.query_params.get('status') == 'new' %}selected{% endif %}>üÜï –ù–æ–≤—ã–π</option>
                    <option value="confirmed" {% if request.query_params.get('status') == 'confirmed' %}selected{% endif %}>‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω</option>
                    <option value="cancelled" {% if request.query_params.get('status') == 'cancelled' %}selected{% endif %}>‚ùå –û—Ç–º–µ–Ω–µ–Ω</option>
                    <option value="delivered" {% if request.query_params.get('status') == 'delivered' %}selected{% endif %}>üöö –î–æ—Å—Ç–∞–≤–ª–µ–Ω</option>
                </select>
            </div>

            <button type="submit" class="filter-button">üîç –§–∏–ª—å—Ç—Ä</button>
            <a href="/orders/orders-page/user-orders/{% if request.query_params.get('user_id') %}?user_id={{ request.query_params.get('user_id') }}{% endif %}" class="filter-button" style="text-decoration:none; background-color: var(--gray);">‚ùå</a>
        </div>
    </form>
</div>
        {% for order in orders %}
        <div class="order" data-order-id="{{ order.id }}" onclick="toggleOrderDetails(this)">
            <div class="order-header">
                <div class="order-number">–ó–∞–∫–∞–∑ ‚Ññ{{ order.order_number }} –æ—Ç {{ order.created_at.strftime('%d.%m.%Y') }} –Ω–∞ —Å—É–º–º—É {{ "%.2f"|format(order.total_amount) }}—Ä.</div>
                <div>
                    <div class="order-status status-{{ order.status }}">
                        {% if order.status == 'new' %}üÜï –ù–æ–≤—ã–π
                        {% elif order.status == 'confirmed' %}‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω
                        {% elif order.status == 'cancelled' %}‚ùå –û—Ç–º–µ–Ω–µ–Ω
                        {% elif order.status == 'delivered' %}üöö –î–æ—Å—Ç–∞–≤–ª–µ–Ω
                        {% else %}{{ order.status }}{% endif %}
                    </div>
                    <span class="toggle-icon">‚ñº</span>
                </div>
            </div>

            <!-- –°–∫—Ä—ã—Ç–∞—è —á–∞—Å—Ç—å -->
            <div class="order-details">
                <p><strong>üìÖ –î–∞—Ç–∞:</strong> {{ order.created_at.strftime('%d.%m.%Y %H:%M') }}</p>

                <div class="customer-info">
                    <p>üë§ –§–ò–û: <a href="/orders/orders-page/user-orders/?user_id={{ order.user_id }}">{{ order.customer_name or '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}</a></p>
                    <p>üìû –¢–µ–ª–µ—Ñ–æ–Ω: {{ order.customer_phone or '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}</p>
                    <p>üè† –ê–¥—Ä–µ—Å: {{ order.customer_address or '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}</p>
                    <p>üöö –°–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏: {{ order.delivery_method or '–ù–µ —É–∫–∞–∑–∞–Ω–æ' }}</p>
                </div>

                {% if order.items %}
                <table class="items-table">
                    <thead>
                        <tr>
                            <th>–¢–æ–≤–∞—Ä</th>
                            <th>–ö–æ–ª-–≤–æ</th>
                            <th>–¶–µ–Ω–∞</th>
                            <th>–°—É–º–º–∞</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in order.items %}
                        <tr>
                            <td>{{ item.product_name }}</td>
                            <td>{{ item.quantity }} —à—Ç</td>
                            <td>{{ "%.2f"|format(item.price) }} ‚ÇΩ</td>
                            <td>{{ "%.2f"|format(item.quantity * item.price) }} ‚ÇΩ</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <p>‚ö†Ô∏è –ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∑–∞–∫–∞–∑–µ</p>
                {% endif %}

                <div class="order-footer">
                    <div class="order-total">üí∞ –°—É–º–º–∞ –∑–∞–∫–∞–∑–∞: {{ "%.2f"|format(order.total_amount) }} ‚ÇΩ</div>
                    <div class="status-actions">
                        {% if order.status == 'new' %}
                        <button class="btn-confirm" onclick="updateStatus({{ order.id }}, 'confirmed')">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                        <button class="btn-cancel" onclick="updateStatus({{ order.id }}, 'cancelled')">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</button>
                        {% elif order.status == 'confirmed' %}
                        <button class="btn-delivered" onclick="updateStatus({{ order.id }}, 'delivered')">üöö –î–æ—Å—Ç–∞–≤–ª–µ–Ω</button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div style="text-align: center; padding: 40px; background: white; border-radius: var(--radius); box-shadow: 0 4px 12px var(--shadow);">
            <h3>üì≠ –ù–µ—Ç –∑–∞–∫–∞–∑–æ–≤</h3>
            <p>–ó–∞–∫–∞–∑–æ–≤ –ø–æ–∫–∞ –Ω–µ –ø–æ—Å—Ç—É–ø–∞–ª–æ.</p>
        </div>
        {% endfor %}
    </div>

    <script>
        function toggleOrderDetails(element) {
            element.classList.toggle('expanded');
        }
    // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
    async function updateStatus(orderId, newStatus) {
        console.log("updateStatus called with:", orderId, newStatus);
        if (!confirm(`–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ ‚Ññ${orderId} –Ω–∞ "${getStatusText(newStatus)}"?`)) return;

        try {
            const response = await fetch('/orders/update-status-json', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    order_id: orderId,
                    new_status: newStatus
                })
            });
            console.log("Fetch response:", response);
            if (response.ok) {
                const result = await response.json();
                console.log("Server result:", result);
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ DOM
                const orderElement = document.querySelector(`.order[data-order-id="${orderId}"]`);
                console.log("Found order element:", orderElement);
                if (orderElement) {
                    const statusElement = orderElement.querySelector('.order-status');
                    console.log("Found status element:", statusElement);
                    if (statusElement) {
                        statusElement.className = `order-status status-${newStatus}`;
                        statusElement.textContent = getStatusText(newStatus);
                        console.log("Updated status element");
                    }

                    const actionsElement = orderElement.querySelector('.status-actions');
                console.log("Found actions element:", actionsElement); // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞–π–¥–µ–Ω –ª–∏ —ç–ª–µ–º–µ–Ω—Ç –∫–Ω–æ–ø–æ–∫
                if (actionsElement) {
                    const newHtml = getNewActionsHtml(newStatus, orderId);
                    console.log("New actions HTML:", newHtml); // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ HTML –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è
                    actionsElement.innerHTML = newHtml;
                    console.log("Updated actions element"); // ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ–º, –æ–±–Ω–æ–≤–∏–ª–∏—Å—å –ª–∏ –∫–Ω–æ–ø–∫–∏
                }
            } else {
                console.error(`Order element with data-order-id='${orderId}' not found`);
            }

            alert(`‚úÖ –°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ ‚Ññ${orderId} –æ–±–Ω–æ–≤–ª—ë–Ω –Ω–∞ "${getStatusText(newStatus)}"`);
        } else {
            const error = await response.json();
            alert(`‚ùå –û—à–∏–±–∫–∞: ${error.detail || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`);
        }
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞:', e);
        alert('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è');
    }
}

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: —Ç–µ–∫—Å—Ç —Å—Ç–∞—Ç—É—Å–∞
    function getStatusText(status) {
        switch (status) {
            case 'new': return 'üÜï –ù–æ–≤—ã–π';
            case 'confirmed': return '‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω';
            case 'cancelled': return '‚ùå –û—Ç–º–µ–Ω–µ–Ω';
            case 'delivered': return 'üöö –î–æ—Å—Ç–∞–≤–ª–µ–Ω';
            default: return status;
        }
    }

    // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è: HTML –∫–Ω–æ–ø–æ–∫
    function getNewActionsHtml(status, orderId) {
        if (status === 'new') {
            return `
                <button class="btn-confirm" onclick="updateStatus(${orderId}, 'confirmed')">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
                <button class="btn-cancel" onclick="updateStatus(${orderId}, 'cancelled')">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</button>
            `;
        } else if (status === 'confirmed') {
            return `
                <button class="btn-delivered" onclick="updateStatus(${orderId}, 'delivered')">üöö –î–æ—Å—Ç–∞–≤–ª–µ–Ω</button>
            `;
        } else {
            return '';
        }
    }
</script>
</body>
</html>